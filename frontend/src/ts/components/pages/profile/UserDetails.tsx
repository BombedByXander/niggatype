import {
  TypingStats as TypingStatsType,
  UserProfile,
  UserProfileDetails,
} from "@monkeytype/schemas/users";
import { differenceInDays } from "date-fns/differenceInDays";
import { formatDate } from "date-fns/format";
import { For, JSXElement, Show } from "solid-js";

import { isFriend } from "../../../db";
import { cn } from "../../../utils/cn";
import { secondsToString } from "../../../utils/date-and-time";
import { formatXp, getXpDetails, XPDetails } from "../../../utils/levels";
import { AutoShrink } from "../../common/AutoShrink";
import { Button } from "../../common/Button";
import { DiscordAvatar } from "../../common/DiscordAvatar";
import { UserBadge, UserFlags } from "../../common/User";

type Variant = "basic" | "hasSocials" | "hasBioOrKeyboard" | "full";

export function UserDetails(props: { profile: UserProfile }): JSXElement {
  const variant = (): Variant => {
    // return "basic";
    // return "hasBioOrKeyboard";
    // return "hasSocials";
    // return "full";
    if (props.profile.banned) return "basic";

    const hasSocials = props.profile.details?.socialProfiles !== undefined;
    const hasBioOrKeyboard =
      props.profile.details?.bio !== undefined ||
      props.profile.details?.keyboard !== undefined;
    if (!hasSocials && !hasBioOrKeyboard) return "basic";
    if (hasSocials && !hasBioOrKeyboard) return "hasSocials";
    if (!hasSocials && hasBioOrKeyboard) return "hasBioOrKeyboard";
    return "full";
  };

  return (
    <div class="grid grid-cols-[1fr_minmax(0,2rem)] rounded-double bg-sub-alt">
      <div
        class={cn(
          "grid items-center gap-4 p-4",
          variant() === "basic" && "md:grid-cols-[17.5rem_auto_1fr]",
          variant() === "hasBioOrKeyboard" &&
            "sm:grid-cols-2 md:grid-cols-[17.5rem_auto_auto_auto_1fr] lg:grid-cols-[17.5rem_auto_1fr_auto_2fr]",
          variant() === "hasSocials" &&
            "sm:grid-cols-2 md:grid-cols-[17.5rem_auto_1fr_auto_auto]",
          variant() === "full" &&
            "sm:grid-cols-2 md:grid-cols-[1fr_auto_1fr_auto] lg:grid-cols-[17.5rem_auto_auto_auto_1fr_auto_auto] xl:lg:grid-cols-[17.5rem_auto_1fr_auto_2fr_auto_auto]",
        )}
      >
        <AvatarAndName profile={props.profile} variant={variant()} />
        <Show when={variant() === "full" || variant() === "hasBioOrKeyboard"}>
          <BioAndKeyboard details={props.profile.details} variant={variant()} />
        </Show>
        <TypingStats
          typingStats={props.profile.typingStats}
          variant={variant()}
        />
        <Show when={variant() === "full" || variant() === "hasSocials"}>
          <Socials
            socials={props.profile.details?.socialProfiles}
            variant={variant()}
          />
        </Show>
      </div>

      <div class="h-full rounded-r hover:bg-text hover:text-bg">
        <div>X</div>
      </div>
    </div>
  );
}

function AvatarAndName(props: {
  profile: UserProfile;
  variant: Variant;
}): JSXElement {
  const accountAgeHint = (): string => {
    const creationDate = new Date(props.profile.addedAt);
    const diffDays = differenceInDays(new Date(), creationDate);
    return `${diffDays} day${diffDays !== 1 ? "s" : ""} ago`;
  };

  function formatStreak(length: number): string {
    return `${length} ${length === 1 ? "day" : "days"}`;
  }

  return (
    // <div class="grid w-full grid-cols-[5rem_1fr] items-center gap-4 self-center text-sub">
    <div
      class={cn(
        "grid w-full grid-cols-[5rem_1fr] items-center gap-4 self-center text-sub",
        props.variant === "hasSocials" && "sm:col-span-2 md:col-span-1",
      )}
    >
      <DiscordAvatar
        class="text-[5rem] text-sub"
        size={256}
        discordAvatar={props.profile.discordAvatar}
        discordId={props.profile.discordId}
      />

      <div class="flex h-full flex-col gap-1 text-xs [&>div]:w-fit">
        <AutoShrink class="flex text-text [&>div]:px-1 [&>div>i]:text-sub">
          {props.profile.name}

          <UserFlags
            {...props.profile}
            isFriend={isFriend(props.profile.uid)}
          />
        </AutoShrink>
        <UserBadge
          id={props.profile.inventory?.badges.find((it) => it.selected)?.id}
        />
        <For
          each={props.profile.inventory?.badges
            .filter((it) => !it.selected)
            .map((it) => it.id)}
        >
          {(badgeId) => <UserBadge id={badgeId} iconOnly />}
        </For>
        <div class="grid">
          <span aria-label={accountAgeHint()} data-balloon-pos="up">
            Joined {formatDate(props.profile.addedAt ?? 0, "dd MMM yyyy")}
          </span>
          <Show when={props.profile.streak ?? 0 > 1}>
            <span
              aria-label={
                "Longest streak: " + formatStreak(props.profile.maxStreak)
              }
              data-balloon-pos="up"
            >
              Current streak {formatStreak(props.profile.streak)}
            </span>
          </Show>
        </div>
      </div>

      <LevelAndBar xp={props.profile.xp} />
    </div>
  );
}

function LevelAndBar(props: { xp?: number }): JSXElement {
  const xpDetails = (): XPDetails => getXpDetails(props.xp ?? 0);
  const bar = (): string =>
    ((xpDetails().levelCurrentXp / xpDetails().levelMaxXp) * 100).toFixed(2) +
    "%";

  return (
    <div class="col-span-2 flex w-full items-center gap-2">
      <div
        class="shrink-0 text-text"
        data-balloon-pos="up"
        aria-label={formatXp(props.xp ?? 0) + " total xp"}
      >
        {xpDetails().level}
      </div>
      <div
        class="h-2 flex-1 rounded bg-sub"
        data-balloon-pos="up"
        aria-label={bar()}
      >
        <div
          class="h-2 rounded bg-main"
          style={{
            width: bar(),
          }}
        >
          &nbsp;
        </div>
      </div>
      <div
        class="shrink-0 text-xs"
        data-balloon-pos="up"
        aria-label={
          formatXp(xpDetails().levelMaxXp - xpDetails().levelCurrentXp) +
          " xp until next level"
        }
      >
        {formatXp(xpDetails().levelCurrentXp)}/
        {formatXp(xpDetails().levelMaxXp)}{" "}
      </div>
    </div>
  );
}

function BioAndKeyboard(props: {
  details?: UserProfileDetails;
  variant: Variant;
}): JSXElement {
  return (
    <>
      <div
        class={cn(
          "hidden h-full w-2 rounded bg-bg",
          props.variant === "hasBioOrKeyboard" && "md:order-3 md:block",
          props.variant === "full" && "md:block lg:order-3",
        )}
      ></div>
      <div
        class={cn(
          "grid h-full content-center gap-2 text-sm",
          props.variant === "hasBioOrKeyboard" && "md:order-4",
          props.variant === "full" && "md:col-span-2 lg:order-4 lg:col-span-1",
        )}
      >
        <div>
          <div class="text-sub">bio</div>
          <div>{props.details?.bio}</div>
        </div>

        <div>
          <div class="text-sub">keyboard</div>
          <div>{props.details?.keyboard}</div>
        </div>
      </div>
    </>
  );
}

function TypingStats(props: {
  typingStats: TypingStatsType;
  variant: Variant;
}): JSXElement {
  return (
    <>
      <div
        class={cn(
          "hidden h-full w-2 rounded bg-bg",
          props.variant === "basic" && "md:block",
          props.variant === "hasBioOrKeyboard" && "md:order-1 md:block",
          props.variant === "hasSocials" && "md:block",
          props.variant === "full" && "lg:order-1 lg:block",
        )}
      ></div>
      {/* <div class="grid grid-cols-[repeat(auto-fit,minmax(10rem,1fr))] gap-4 sm:grid-cols-3 lg:flex lg:flex-col"> */}
      <div
        class={cn(
          "grid grid-cols-[repeat(auto-fit,minmax(10rem,1fr))] gap-2",
          props.variant === "basic" &&
            "sm:grid-cols-3 md:grid-cols-1 lg:grid-cols-3 lg:text-[1.25rem]",
          props.variant === "hasBioOrKeyboard" &&
            "sm:col-span-2 md:order-2 md:col-span-1 md:grid-cols-1",
          props.variant === "hasSocials" &&
            "sm:col-span-2 sm:grid-cols-3 md:col-span-1 md:grid-cols-1 lg:grid-cols-3 xl:text-[1.25rem]",
          props.variant === "full" &&
            "sm:col-span-2 sm:grid-cols-3 md:col-span-3 md:grid-cols-3 lg:order-2 lg:col-span-1 lg:grid-cols-1",
        )}
      >
        <div class="flex flex-col">
          <div class="text-em-sm text-sub">tests started</div>
          <div class="text-em-2xl leading-6">
            {props.typingStats.startedTests}
          </div>
        </div>
        <div class="flex flex-col">
          <div class="text-em-sm text-sub">tests completed</div>
          <div class="text-em-2xl leading-6">
            {props.typingStats.completedTests}
          </div>
        </div>
        <div class="flex flex-col">
          <div class="text-em-sm text-sub">time typing</div>
          <div class="text-em-2xl leading-6">
            {secondsToString(
              Math.round(props.typingStats.timeTyping ?? 0),
              true,
              true,
            )}
          </div>
        </div>
      </div>
    </>
  );
}

function Socials(props: {
  socials?: UserProfileDetails["socialProfiles"];
  variant: Variant;
}): JSXElement {
  return (
    <>
      <div
        class={cn(
          "hidden h-full w-2 rounded bg-bg",
          props.variant === "hasSocials" && "md:block",
          props.variant === "full" && "md:hidden lg:order-5 lg:block",
        )}
      ></div>
      <div class={cn(props.variant === "full" && "lg:order-6")}>
        <div
          class={cn(
            "text-sm text-sub md:hidden",
            props.variant === "full" && "md:block lg:hidden",
          )}
        >
          socials
        </div>
        <div
          class={cn(
            "flex gap-2 text-2xl text-text md:flex-col lg:flex-col [&>a]:text-text [&>a]:hover:text-main",
            props.variant === "full" && "md:flex-row",
          )}
        >
          <Show when={props.socials?.github}>
            <Button
              type="text"
              fa={{ icon: "fa-github", variant: "brand", fixedWidth: true }}
              href={`https://github.com/${props.socials?.github}`}
              class="p-0"
            />
          </Show>
          <Show when={props.socials?.twitter}>
            <Button
              type="text"
              fa={{ icon: "fa-twitter", variant: "brand", fixedWidth: true }}
              href={`https://x.com/${props.socials?.twitter}`}
              class="p-0"
            />
          </Show>
          <Show when={props.socials?.website}>
            <Button
              type="text"
              fa={{ icon: "fa-globe", fixedWidth: true }}
              href={props.socials?.website ?? ""}
              class="p-0"
            />
          </Show>
        </div>
      </div>
    </>
  );
}
